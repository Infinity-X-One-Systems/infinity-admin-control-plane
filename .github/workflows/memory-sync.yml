# ============================================================
# INFINITY ADMIN CONTROL PLANE — Memory Sync
# Reads the latest state from infinity-core-memory and writes
# a snapshot to _STATE/memory-snapshot.json.
# ============================================================
name: Memory Sync

on:
  schedule:
    # Every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    name: Sync Memory Snapshot
    runs-on: ubuntu-latest

    steps:
      - name: Checkout admin control plane
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch memory snapshot from infinity-core-memory
        env:
          GH_TOKEN: ${{ secrets.GH_ORG_READ_TOKEN || secrets.GITHUB_TOKEN }}
          MEMORY_REPO: 'Infinity-X-One-Systems/infinity-core-memory'
        run: |
          python3 << 'PYEOF'
          import json, os, urllib.request, urllib.error, datetime

          TOKEN       = os.environ.get("GH_TOKEN", "")
          MEMORY_REPO = os.environ.get("MEMORY_REPO", "Infinity-X-One-Systems/infinity-core-memory")

          headers = {"Accept": "application/vnd.github+json", "X-GitHub-Api-Version": "2022-11-28"}
          if TOKEN:
              headers["Authorization"] = f"Bearer {TOKEN}"

          entries = []

          # Try to read DECISIONS.md, DEPLOYMENTS.md, RISKS.md, BENCHMARKS.md
          FILES = {
              "decision":   "DECISIONS.md",
              "deployment": "DEPLOYMENTS.md",
              "risk":       "RISKS.md",
              "benchmark":  "BENCHMARKS.md",
          }

          for entry_type, filename in FILES.items():
              url = f"https://api.github.com/repos/{MEMORY_REPO}/contents/{filename}"
              req = urllib.request.Request(url, headers=headers)
              try:
                  with urllib.request.urlopen(req) as resp:
                      file_data = json.loads(resp.read())
                  import base64
                  content = base64.b64decode(file_data.get("content", "")).decode("utf-8", errors="replace")
                  # Parse markdown sections (## heading lines as entries)
                  for block in content.split("\n## "):
                      if not block.strip():
                          continue
                      lines = block.strip().split("\n")
                      title = lines[0].strip("# ").strip()
                      body  = "\n".join(lines[1:]).strip()[:400]
                      entries.append({
                          "type":      entry_type,
                          "timestamp": datetime.datetime.utcnow().isoformat() + "Z",
                          "title":     title,
                          "body":      body,
                      })
              except Exception as e:
                  print(f"Skipping {filename}: {e}")

          # Also read the latest commits as activity log
          commits_url = f"https://api.github.com/repos/{MEMORY_REPO}/commits?per_page=10"
          req = urllib.request.Request(commits_url, headers=headers)
          try:
              with urllib.request.urlopen(req) as resp:
                  commits = json.loads(resp.read())
              for c in commits:
                  entries.append({
                      "type":      "commit",
                      "timestamp": c["commit"]["author"]["date"],
                      "title":     c["commit"]["message"].split("\n")[0][:100],
                      "body":      f"Author: {c['commit']['author']['name']} · SHA: {c['sha'][:8]}",
                  })
          except Exception as e:
              print(f"Could not fetch commits: {e}")

          # Sort by timestamp descending
          entries.sort(key=lambda e: e.get("timestamp", ""), reverse=True)

          output = {
              "source":    MEMORY_REPO,
              "syncedAt":  datetime.datetime.utcnow().isoformat() + "Z",
              "entryCount": len(entries),
              "entries":   entries[:100],  # keep latest 100
          }

          os.makedirs("_STATE", exist_ok=True)
          with open("_STATE/memory-snapshot.json", "w") as f:
              json.dump(output, f, indent=2)

          print(f"Wrote {len(entries)} memory entries to _STATE/memory-snapshot.json")
          PYEOF

      - name: Commit updated snapshot
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add _STATE/memory-snapshot.json
          git diff --staged --quiet && echo "No changes" && exit 0
          git commit -m "chore: sync memory snapshot [$(date -u +%Y-%m-%dT%H:%MZ)]"
          git push
